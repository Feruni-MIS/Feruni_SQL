TRUNCATE TABLE [dbo].[_quotation_ft_quotationline]
INSERT INTO [dbo].[_quotation_ft_quotationline]

SELECT 
    T1.[SALESQUOTATIONNUMBER], 
    T1.[INVENTORYLOTID], 
    T1.[SALESQUOTATIONSTATUS], 
    T1.[ITEMNUMBER], 
    T1.[LINEAMOUNT], 
    T1.[LINEDISCOUNTAMOUNT], 
    T1.[LINEDISCOUNTPERCENTAGE], 
    T1.[MULTILINEDISCOUNTAMOUNT], 
    T1.[MULTILINEDISCOUNTPERCENTAGE], 
    T1.[LINEDESCRIPTION], 
    T1.[SALESPRICEQUANTITY], 
    T1.[REQUESTEDRECEIPTDATE], 
    T1.[SALESPRICE], 
    T1.[REQUESTEDSALESQUANTITY], 
    T1.[REQUESTEDSHIPPINGDATE], 
    T1.[SALESPRODUCTCATEGORYNAME], 
    T1.[MAINACCOUNTIDDISPLAYVALUE], 
    T1.[DEFAULTLEDGERDIMENSIONDISPLAYVALUE], 
    T1.[PRODUCTSTYLEID], 
    T1.[PRODUCTSIZEID], 
    T1.[PRODUCTCOLORID], 
    T1.[ITEMBATCHNUMBER], 
    T1.[PRODUCTCONFIGURATIONID], 
    T1.[LINECREATIONSEQUENCENUMBER], 
    T1.[INVOICECUSTOMERACCOUNTNUMBER], 
    T1.[PROSPECTID], 
    T1.[DATAAREAID], 
    T1.[COMMISSIONSALESREPRESENTATIVEGROUPID],
    'Product Helper' = SUBSTRING
                      (
                                  T1.[ITEMNUMBER] + 
                                  IIF(T1.[PRODUCTCOLORID] = NULL, '', T1.[PRODUCTCOLORID]) +
                                  IIF(T1.[PRODUCTSTYLEID] = NULL, '', T1.[PRODUCTSTYLEID]) +
                                  IIF(T1.[PRODUCTSIZEID] = NULL, '', T1.[PRODUCTSIZEID]) +
                                  IIF(T1.[PRODUCTCONFIGURATIONID] = NULL, '', T1.[PRODUCTCONFIGURATIONID]), 
                                  1, 
                                  200
                      ), 
    T1.[DATAAREAID] + T1.[DEFAULTLEDGERDIMENSIONDISPLAYVALUE] AS 'FinDim Code', 
    LEFT(T1.[INVENTORYLOTID], 4) +                          ---Text.Middle([INVENTORYLOTID], 0, 4) 
    '-' +
    REVERSE                                                 ---Text.Middle([INVENTORYLOTID], Text.PositionOf([INVENTORYLOTID], "-", Occurrence.Last), 7)
    (
      LEFT(
        REVERSE(T1.[INVENTORYLOTID]), 
        CHARINDEX('-', REVERSE(T1.[INVENTORYLOTID])) -1
      )
    ) AS "Inventory Lot ID", 
    T2.[RECEIPTDATEREQUESTED],
    T2.[SALESQUOTATIONFOLLOWUPDATE],                        ---RETAIL SALES FUNNEL FORECAST DATE  BY KE
    T2.[SALESQUOTATIONTYPEID] AS "Confidence Level",        ---RETAIL SALES FUNNEL EST QUOTATION DECISION BY KE
    T2.[QUOTATIONRESPONSIBLEPERSONNELNUMBER],               ---RETAIL SALES FUNNEL SALES PERSON BY KE
    T2.[QUOTATIONTAKERPERSONNELNUMBER],                     ---RETAIL SALES FUNNEL SALES PERSON BY KE
    T2.[QUOTATIONREASONCODE],                               ---ADDED BY KE REQUIRED FOR LOST REASON -RETAIL SALES FUNNEL
    T2.[CREATEDDATETIME1],
    T2.[CREATEDDATETIME1] AS "Quotation_Creation_Date",
    T3.[Quotation Status Description],
    T4.[CUSTOMERACCOUNT],                                   ---ADDED BY KE REQUIRED FOR CUSTOMER INFO IN RETAIL SALES FUNNEL
    T4.[ORGANIZATIONNAME],                                  ---ADDED BY KE REQUIRED FOR CUSTOMER INFO IN RETAIL SALES FUNNEL
    T4.[CUSTOMERGROUPID],                                   ---ADDED BY KE REQUIRED FOR CUSTOMER INFO IN RETAIL SALES FUNNEL
    T4.[REFERRAL],                                          ---ADDED BY KE REQUIRED FOR CUSTOMER INFO IN RETAIL SALES FUNNEL
    T5.[NAME] AS "Quotation Responsible Personnel Name"
FROM 
  [dbo].[SalesQuotationLineV2Staging] AS T1 
LEFT JOIN 
(
  SELECT 
    [SALESQUOTATIONNUMBER], 
    [RECEIPTDATEREQUESTED],
    [SALESQUOTATIONTYPEID],
    [SALESQUOTATIONFOLLOWUPDATE],
    [QUOTATIONRESPONSIBLEPERSONNELNUMBER],
    [QUOTATIONTAKERPERSONNELNUMBER],
    [QUOTATIONREASONCODE],                                  ---ADDED BY KE REQUIRED FOR LOST REASON -RETAIL SALES FUNNEL
    [CREATEDDATETIME1]
  FROM 
    [dbo].[SalesQuotationHeaderV2Staging]
) T2 
ON T1.[SALESQUOTATIONNUMBER] = T2.[SALESQUOTATIONNUMBER] 
LEFT JOIN 
(
  SELECT 
    [Quotation Status], 
    [Quotation Status Description] 
  FROM 
    [dbo].[_quotation_df_quotationstatus]
) T3 
ON T1.[SALESQUOTATIONSTATUS] = T3.[Quotation Status]
LEFT JOIN 
(
  SELECT
    [CUSTOMERACCOUNT]
    ,[ORGANIZATIONNAME]
    ,[CUSTOMERGROUPID]
    ,[REFERRAL]
    FROM [dbo].[CustCustomerV3Staging]
) T4 
ON T1.[INVOICECUSTOMERACCOUNTNUMBER] = T4.[CUSTOMERACCOUNT]
LEFT JOIN 
(
  SELECT
    [PERSONNELNUMBER]
    ,[NAME]
    FROM [dbo].[_humanresources_dm_employee]
) T5 
ON T2.[QUOTATIONRESPONSIBLEPERSONNELNUMBER] = T5.[PERSONNELNUMBER]
